"use strict";(()=>{var e={};e.id=798,e.ids=[798],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3263:e=>{e.exports=import("firebase-admin/app")},79637:e=>{e.exports=import("firebase-admin/auth")},72929:e=>{e.exports=import("firebase-admin/firestore")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},6005:e=>{e.exports=require("node:crypto")},73837:e=>{e.exports=require("util")},47016:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{headerHooks:()=>p,originalPathname:()=>y,requestAsyncStorage:()=>d,routeModule:()=>c,serverHooks:()=>l,staticGenerationAsyncStorage:()=>u,staticGenerationBailout:()=>m});var i=a(10884),s=a(16132),n=a(93518),o=e([n]);n=(o.then?(await o)():o)[0];let c=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"/Users/johnmutende/Downloads/tutora-main/tutora-admin-portal/src/app/api/webhooks/stripe/route.ts",nextConfigOutput:"export",userland:n}),{requestAsyncStorage:d,staticGenerationAsyncStorage:u,serverHooks:l,headerHooks:p,staticGenerationBailout:m}=c,y="/api/webhooks/stripe/route";r()}catch(e){r(e)}})},93518:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{POST:()=>POST});var i=a(95798),s=a(11343),n=a(83479),o=e([n]);async function POST(e){try{let t=await e.text(),a=e.headers.get("stripe-signature");if(!a)return i.Z.json({error:"No signature provided"},{status:400});let r=await s.Rz.constructWebhookEvent(t,a);switch(console.log("Webhook event received:",r.type),r.type){case"checkout.session.completed":await handleCheckoutCompleted(r);break;case"customer.subscription.created":await handleSubscriptionCreated(r);break;case"customer.subscription.updated":await handleSubscriptionUpdated(r);break;case"customer.subscription.deleted":await handleSubscriptionDeleted(r);break;case"invoice.payment_succeeded":await handlePaymentSucceeded(r);break;case"invoice.payment_failed":await handlePaymentFailed(r);break;default:console.log(`Unhandled event type: ${r.type}`)}return i.Z.json({received:!0})}catch(e){return console.error("Webhook error:",e),i.Z.json({error:"Webhook handler failed"},{status:400})}}async function handleCheckoutCompleted(e){let t=e.data.object;console.log("Checkout completed for session:",t.id);try{let e=await s.Rz.getCustomer(t.customer),a={name:t.metadata?.companyName||"New Company",email:e.email||t.customer_email,stripeCustomerId:t.customer,stripeSubscriptionId:t.subscription,adminUser:{name:t.metadata?.adminName||"Admin",email:e.email||t.customer_email}},r=t.metadata?.planId||"basic",i=await n.BS.createCompany(a,r);console.log("Company created successfully:",i.companyCode)}catch(e){console.error("Error creating company:",e)}}async function handleSubscriptionCreated(e){let t=e.data.object;console.log("Subscription created:",t.id),console.log("Subscription details:",{id:t.id,customerId:t.customer,status:t.status,planId:t.metadata?.planId||"unknown"})}async function handleSubscriptionUpdated(e){let t=e.data.object;console.log("Subscription updated:",t.id),console.log("Subscription status:",t.status)}async function handleSubscriptionDeleted(e){let t=e.data.object;console.log("Subscription deleted:",t.id),console.log("Subscription cancelled for customer:",t.customer)}async function handlePaymentSucceeded(e){let t=e.data.object;console.log("Payment succeeded for invoice:",t.id),console.log("Payment amount:",t.amount_paid/100)}async function handlePaymentFailed(e){let t=e.data.object;console.log("Payment failed for invoice:",t.id),console.log("Payment failure reason:",t.last_payment_error?.message||"Unknown")}n=(o.then?(await o)():o)[0],r()}catch(e){r(e)}})},83479:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{BS:()=>p});var i=a(3263),s=a(72929),n=a(79637),o=a(50332),c=e([i,s,n]);[i,s,n]=c.then?(await c)():c;let d={projectId:"your-firebase-project-id",clientEmail:"your-firebase-service-account-email",privateKey:"-----BEGIN PRIVATE KEY-----\nyour-private-key-here\n-----END PRIVATE KEY-----".replace(/\\n/g,"\n")},u=null;if(0===(0,i.getApps)().length)try{u=(0,i.initializeApp)({credential:(0,i.cert)(d),projectId:"your-firebase-project-id"})}catch(e){console.log("Firebase initialization failed, running in development mode:",e),u=null}else(0,i.getApps)().length>0&&(u=(0,i.getApps)()[0]);let l=u?(0,s.getFirestore)(u):null;u&&(0,n.getAuth)(u);let FirebaseService=class FirebaseService{constructor(){}async createCompany(e,t){let a=await this.generateCompanyCode(),r={id:(0,o.x0)(),name:e.name,email:e.email,companyCode:a,plan:t,status:"active",createdAt:new Date,updatedAt:new Date,maxUsers:this.getMaxUsers(t),maxModules:this.getMaxModules(t),currentUsers:0,currentModules:0,stripeCustomerId:e.stripeCustomerId,stripeSubscriptionId:e.stripeSubscriptionId,settings:{customBranding:"basic"!==t,whiteLabel:"enterprise"===t,primaryColor:"#2E9CFF",secondaryColor:"#64B5FF"},adminUser:{name:e.adminUser?.name||"Admin",email:e.email,phone:e.adminUser?.phone},billing:{address:e.billing?.address,city:e.billing?.city,country:e.billing?.country,postalCode:e.billing?.postalCode,taxId:e.billing?.taxId}};if(l)try{await l.collection("companies").doc(r.id).set(r),console.log("Company saved to Firebase:",r.companyCode)}catch(e){console.log("Failed to save to Firebase, running in development mode:",e)}else console.log("Firebase not available, running in development mode");return console.log("Company created:",r),r}async generateCompanyCode(){let e=new Date().getFullYear(),t=Math.random().toString(36).substring(2,8).toUpperCase();return`TUT-${e}-${t}`}getMaxUsers(e){switch(e){case"basic":default:return 50;case"premium":return 200;case"enterprise":return 1e3}}getMaxModules(e){switch(e){case"basic":default:return 10;case"premium":return 50;case"enterprise":return 200}}async getCompanyByCode(e){return console.log("Getting company by code:",e),null}async getCompany(e){return console.log("Getting company by ID:",e),null}async getAllCompanies(){return console.log("Getting all companies"),[]}async getCompanyAnalytics(e){return console.log("Getting company analytics:",e),{totalUsers:0,activeUsers:0,totalModules:0,completedModules:0,userGrowth:0,moduleCompletions:0,averageScore:0,certificatesIssued:0}}};let p=new FirebaseService;r()}catch(e){r(e)}})},11343:(e,t,a)=>{a.d(t,{Rz:()=>n});var r=a(78888);let i=new r.Z("sk_test_your_stripe_secret_key_here",{apiVersion:"2023-10-16",typescript:!0}),s={basic:{id:"basic",name:"Basic",price:99,interval:"month",features:["Up to 50 users","Basic training modules","Progress tracking","Email support","Basic analytics"],maxUsers:50,maxModules:10,priority:"basic",stripePriceId:"price_basic_monthly"},premium:{id:"premium",name:"Premium",price:299,interval:"month",features:["Up to 200 users","Advanced training modules","Custom quizzes","Advanced analytics","Priority support","Custom branding"],maxUsers:200,maxModules:50,priority:"premium",stripePriceId:"price_premium_monthly"},enterprise:{id:"enterprise",name:"Enterprise",price:999,interval:"month",features:["Unlimited users","Custom training modules","Advanced AI features","White-label solution","Dedicated support","Custom integrations","SLA guarantee"],maxUsers:-1,maxModules:-1,priority:"enterprise",stripePriceId:"price_enterprise_monthly"}};let StripeService=class StripeService{constructor(){this.stripe=i}async createCheckoutSession(e,t,a,r){let i=s[e];if(!i)throw Error("Invalid plan ID");let n=await this.stripe.checkout.sessions.create({payment_method_types:["card"],line_items:[{price_data:{currency:"usd",product_data:{name:`Tutora ${i.name} Plan`,description:`${i.features.join(", ")}`,images:["https://tutora.com/logo.png"]},unit_amount:100*i.price,recurring:{interval:i.interval}},quantity:1}],mode:"subscription",success_url:t,cancel_url:a,metadata:{planId:e,...r},subscription_data:{metadata:{planId:e,...r}},customer_creation:"always",billing_address_collection:"required",tax_id_collection:{enabled:!0}});return n}async createCustomer(e,t,a){let r=await this.stripe.customers.create({email:e,name:t,metadata:{companyName:a,source:"tutora_admin_portal"}});return r}async createPortalSession(e,t){let a=await this.stripe.billingPortal.sessions.create({customer:e,return_url:t});return a}async getSubscription(e){return await this.stripe.subscriptions.retrieve(e)}async updateSubscription(e,t){let a=await this.stripe.subscriptions.retrieve(e),r=s[t];if(!r)throw Error("Invalid plan ID");let i=await this.stripe.prices.create({currency:"usd",unit_amount:100*r.price,recurring:{interval:r.interval},product_data:{name:`Tutora ${r.name} Plan`}});return await this.stripe.subscriptions.update(e,{items:[{id:a.items.data[0].id,price:i.id}],metadata:{planId:t}})}async cancelSubscription(e){return await this.stripe.subscriptions.cancel(e)}async getCustomer(e){return await this.stripe.customers.retrieve(e)}async constructWebhookEvent(e,t){let a=process.env.STRIPE_WEBHOOK_SECRET;try{return this.stripe.webhooks.constructEvent(e,t,a)}catch(e){throw Error(`Webhook signature verification failed: ${e}`)}}async handleWebhookEvent(e){switch(e.type){case"checkout.session.completed":return await this.handleCheckoutCompleted(e.data.object);case"customer.subscription.created":return await this.handleSubscriptionCreated(e.data.object);case"customer.subscription.updated":return await this.handleSubscriptionUpdated(e.data.object);case"customer.subscription.deleted":return await this.handleSubscriptionDeleted(e.data.object);case"invoice.payment_succeeded":return await this.handlePaymentSucceeded(e.data.object);case"invoice.payment_failed":return await this.handlePaymentFailed(e.data.object);default:console.log(`Unhandled event type: ${e.type}`)}}async handleCheckoutCompleted(e){let{planId:t}=e.metadata,a=s[t];return{type:"checkout_completed",customerId:e.customer,subscriptionId:e.subscription,planId:t,plan:a,session:e}}async handleSubscriptionCreated(e){return{type:"subscription_created",customerId:e.customer,subscriptionId:e.id,planId:e.metadata.planId,subscription:e}}async handleSubscriptionUpdated(e){return{type:"subscription_updated",customerId:e.customer,subscriptionId:e.id,planId:e.metadata.planId,subscription:e}}async handleSubscriptionDeleted(e){return{type:"subscription_deleted",customerId:e.customer,subscriptionId:e.id,planId:e.metadata.planId,subscription:e}}async handlePaymentSucceeded(e){return{type:"payment_succeeded",customerId:e.customer,subscriptionId:e.subscription,amount:e.amount_paid,invoice:e}}async handlePaymentFailed(e){return{type:"payment_failed",customerId:e.customer,subscriptionId:e.subscription,amount:e.amount_due,invoice:e}}};let n=new StripeService}};var t=require("../../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[535,332],()=>__webpack_exec__(47016));module.exports=a})();